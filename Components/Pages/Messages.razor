@page "/messages"
@using StudioAlAmalWeb.Models
@using StudioAlAmalWeb.Services
@inject CommunicationService CommService
@inject AuthenticationService AuthService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Messages - Studio Al Amal Admin</PageTitle>

@if (!isAuthenticated)
{
    <div class="alert alert-warning">
        <p>You must be logged in to view messages.</p>
        <a href="/login" class="btn btn-primary">Login</a>
    </div>
}
else
{
    <div class="messages-page">
        <div class="messages-header">
            <h1>Contact Messages</h1>
            <div class="header-actions">
                <button class="btn @(showUnreadOnly ? "btn-primary" : "btn-outline-primary")"
                        @onclick="ToggleUnreadFilter">
                    @(showUnreadOnly ? $"Unread ({unreadCount})" : "All Messages")
                </button>
                <button class="btn btn-secondary" @onclick="LoadMessages">
                    <span class="refresh-icon">↻</span> Refresh
                </button>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="loading-state">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Loading messages...</p>
            </div>
        }
        else if (!messages.Any())
        {
            <div class="empty-state">
                <div class="empty-icon">📭</div>
                <h3>No messages found</h3>
                <p>@(showUnreadOnly ? "All messages have been read!" : "No one has contacted you yet.")</p>
            </div>
        }
        else
        {
            <div class="messages-grid">
                @foreach (var message in messages)
                {
                    <div class="message-card @(message.IsRead ? "read" : "unread")">
                        <div class="message-header">
                            <div class="message-info">
                                <h3>@message.FullName</h3>
                                <span class="message-date">@message.SubmittedAt.ToString("MMM dd, yyyy HH:mm")</span>
                            </div>
                            @if (!message.IsRead)
                            {
                                <span class="unread-badge">New</span>
                            }
                        </div>

                        <div class="message-subject">
                            <strong>Subject:</strong> @message.Subject
                        </div>

                        <div class="message-contact">
                            <div><strong>Email:</strong> @message.Email</div>
                            @if (!string.IsNullOrEmpty(message.Phone))
                            {
                                <div><strong>Phone:</strong> @message.Phone</div>
                            }
                        </div>

                        <div class="message-body">
                            @message.Message
                        </div>

                        <div class="message-actions">
                            @if (!message.IsRead)
                            {
                                <button class="btn btn-sm btn-success" @onclick="() => MarkAsRead(message.Id)">
                                    ✓ Mark as Read
                                </button>
                            }
                            else
                            {
                                <span class="text-muted">
                                    Read on @message.ReadAt?.ToString("MMM dd, HH:mm")
                                </span>
                            }
                            <button class="btn btn-sm btn-danger" @onclick="() => DeleteMessage(message.Id)">
                                🗑 Delete
                            </button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}

<style>
    .messages-page {
        max-width: 1400px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .messages-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 20px;
    }

        .messages-header h1 {
            margin: 0;
            color: #333;
        }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .refresh-icon {
        display: inline-block;
        font-size: 1.2em;
    }

    .loading-state, .empty-state {
        text-align: center;
        padding: 60px 20px;
    }

    .empty-icon {
        font-size: 5rem;
        margin-bottom: 20px;
    }

    .messages-grid {
        display: grid;
        gap: 20px;
    }

    .message-card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #ddd;
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .message-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .message-card.unread {
            border-left-color: #667eea;
            background: #f8f9ff;
        }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 15px;
    }

    .message-info h3 {
        margin: 0 0 5px 0;
        color: #333;
        font-size: 1.3rem;
    }

    .message-date {
        color: #888;
        font-size: 0.9rem;
    }

    .unread-badge {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .message-subject {
        margin-bottom: 10px;
        font-size: 1.05rem;
    }

    .message-contact {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        color: #666;
        font-size: 0.95rem;
    }

    .message-body {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
        line-height: 1.6;
        color: #333;
    }

    .message-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .btn-sm {
        padding: 6px 15px;
        font-size: 0.9rem;
    }
</style>

@code {
    private bool isAuthenticated = false;
    private List<ContactSubmission> messages = new();
    private bool isLoading = false;
    private bool showUnreadOnly = false;
    private int unreadCount = 0;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsAuthenticatedAsync();

        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadMessages();
    }

    private async Task LoadMessages()
    {
        isLoading = true;

        try
        {
            messages = await CommService.GetContactSubmissionsAsync(showUnreadOnly);

            // Count unread messages
            unreadCount = messages.Count(m => !m.IsRead);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading messages: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ToggleUnreadFilter()
    {
        showUnreadOnly = !showUnreadOnly;
        await LoadMessages();
    }

    private async Task MarkAsRead(int id)
    {
        var success = await CommService.MarkAsReadAsync(id);

        if (success)
        {
            // Reload messages to show updated state
            await LoadMessages();
        }
    }

    private async Task DeleteMessage(int id)
    {
        // Ask for confirmation (simple version - you could make this fancier)
        var success = await CommService.DeleteSubmissionAsync(id);

        if (success)
        {
            // Reload messages
            await LoadMessages();
        }
    }
}