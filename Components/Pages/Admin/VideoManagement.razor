@using StudioAlAmalWeb.Models
@using StudioAlAmalWeb.Services
@inject ContentService ContentService
@rendermode @(new InteractiveServerRenderMode(prerender: false))

<div class="content-management">
    <div class="section-header">
        <h2>Manage Videos</h2>
        <button class="btn btn-primary" @onclick="ToggleAddForm">
            @(showAddForm ? "Cancel" : "+ Add New Video")
        </button>
    </div>

    @if (showAddForm)
    {
        <div class="add-form-card">
            <h3>Add New Video</h3>
            <EditForm Model="newVideo" OnValidSubmit="HandleCreateVideo" FormName="createVideoForm">
                <DataAnnotationsValidator />

                <div class="form-group">
                    <label>Title *</label>
                    <InputText class="form-control" @bind-Value="newVideo.Title" />
                    <ValidationMessage For="@(() => newVideo.Title)" />
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <InputTextArea class="form-control" @bind-Value="newVideo.Description" rows="3" />
                </div>

                <div class="form-group">
                    <label>Video URL * (YouTube, Vimeo, or direct link)</label>
                    <InputText class="form-control" @bind-Value="newVideo.VideoUrl"
                               placeholder="https://www.youtube.com/watch?v=..." />
                    <ValidationMessage For="@(() => newVideo.VideoUrl)" />
                </div>

                <div class="form-group">
                    <label>Thumbnail URL (optional)</label>
                    <InputText class="form-control" @bind-Value="newVideo.ThumbnailUrl" />
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Duration (seconds)</label>
                        <InputNumber class="form-control" @bind-Value="newVideo.Duration" />
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <InputSelect class="form-control" @bind-Value="newVideo.Category">
                            <option value="">Select category...</option>
                            <option value="Wedding">Wedding</option>
                            <option value="Event">Event</option>
                            <option value="Corporate">Corporate</option>
                            <option value="Behind the Scenes">Behind the Scenes</option>
                        </InputSelect>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Display Order</label>
                        <InputNumber class="form-control" @bind-Value="newVideo.DisplayOrder" />
                    </div>

                    <div class="form-group">
                        <label>
                            <InputCheckbox @bind-Value="newVideo.IsActive" />
                            Active
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                    @(isSubmitting ? "Adding..." : "Add Video")
                </button>

                @if (!string.IsNullOrEmpty(message))
                {
                    <div class="alert @(messageIsSuccess ? "alert-success" : "alert-danger") mt-3">
                        @message
                    </div>
                }
            </EditForm>
        </div>
    }

    @if (isLoading)
    {
        <div class="loading-state">Loading videos...</div>
    }
    else if (!videos.Any())
    {
        <div class="empty-state">
            <p>No videos yet. Add your first video above!</p>
        </div>
    }
    else
    {
        <div class="items-grid">
            @foreach (var video in videos)
            {
                <div class="item-card">
                    <div class="item-image">
                        @if (!string.IsNullOrEmpty(video.ThumbnailUrl))
                        {
                            <img src="@video.ThumbnailUrl" alt="@video.Title" />
                        }
                        else
                        {
                            <div class="video-placeholder">🎬</div>
                        }
                        @if (!video.IsActive)
                        {
                            <span class="inactive-badge">Inactive</span>
                        }
                        @if (!string.IsNullOrEmpty(video.Category))
                        {
                            <span class="category-badge">@video.Category</span>
                        }
                    </div>
                    <div class="item-content">
                        <h4>@video.Title</h4>
                        @if (!string.IsNullOrEmpty(video.Description))
                        {
                            <p>@video.Description</p>
                        }
                        <div class="item-meta">
                            <small>Duration: @(video.Duration.HasValue ? $"{video.Duration}s" : "N/A")</small>
                            <small>@video.CreatedAt.ToString("MMM dd, yyyy")</small>
                        </div>
                    </div>
                    <div class="item-actions">
                        <a href="@video.VideoUrl" target="_blank" class="btn btn-sm btn-info">View</a>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteVideo(video.Id)">
                            Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .content-management {
        width: 100%;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

        .section-header h2 {
            margin: 0;
            color: #333;
        }

    .add-form-card {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

        .add-form-card h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .item-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
    }

    .item-image {
        position: relative;
        width: 100%;
        height: 200px;
        overflow: hidden;
        background: #f0f0f0;
    }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .video-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 4rem;
    }

    .inactive-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
    }

    .category-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(102, 126, 234, 0.9);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
    }

    .item-content {
        padding: 15px;
    }

        .item-content h4 {
            margin: 0 0 10px 0;
        }

        .item-content p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 0.95rem;
        }

    .item-meta {
        display: flex;
        justify-content: space-between;
        padding-top: 10px;
        border-top: 1px solid #eee;
        font-size: 0.85rem;
        color: #888;
    }

    .item-actions {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .loading-state, .empty-state {
        text-align: center;
        padding: 40px;
        color: #888;
    }
</style>

@code {
    [SupplyParameterFromForm]
    private VideoCreateDto newVideo { get; set; } = new();

    private List<Video> videos = new();
    private bool showAddForm = false;
    private bool isLoading = false;
    private bool isSubmitting = false;
    private string message = string.Empty;
    private bool messageIsSuccess = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadVideos();
        }
    }

    private async Task LoadVideos()
    {
        isLoading = true;
        StateHasChanged();

        videos = await ContentService.GetVideosAsync();

        isLoading = false;
        StateHasChanged();
    }

    private void ToggleAddForm()
    {
        showAddForm = !showAddForm;
        if (!showAddForm) message = string.Empty;
    }

    private async Task HandleCreateVideo()
    {
        isSubmitting = true;
        message = string.Empty;

        var (success, msg) = await ContentService.CreateVideoAsync(newVideo);

        messageIsSuccess = success;
        message = msg;

        if (success)
        {
            newVideo = new();
            await LoadVideos();
            await Task.Delay(2000);
            showAddForm = false;
            message = string.Empty;
        }

        isSubmitting = false;
    }

    private async Task DeleteVideo(int id)
    {
        var success = await ContentService.DeleteVideoAsync(id);
        if (success) await LoadVideos();
    }
}